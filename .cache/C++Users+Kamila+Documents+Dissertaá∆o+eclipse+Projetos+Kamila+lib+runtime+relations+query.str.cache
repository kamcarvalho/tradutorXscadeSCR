Module("runtime/relations/query",[Imports([Import("runtime/relations/entries"),Import("runtime/relations/interface"),Import("runtime/index/query"),Import("runtime/task/insert")]),Rules([RDefT("relation-lookup",[],[DefaultVarDec("rel")],Rule(Var("term"),App(Call(SVar("map"),[CallNoArgs(SVar("relation-try-term-to-uri"))]),NoAnnoList(List([Var(ListVar("refl-val*")),Var(ListVar("val*"))]))),Seq(Assign(Var(ListVar("refl-val*")),App(LChoice(Seq(CallNoArgs(SVar("relation-is-reflexive")),Build(NoAnnoList(List([Var("term")])))),Build(NoAnnoList(List([])))),Var("rel"))),LChoice(Assign(Var(ListVar("val*")),App(Seq(CallT(SVar("relation-lookup-internal"),[],[Var("rel")]),Where(CallNoArgs(SVar("Hd")))),Var("term"))),Assign(Var(ListVar("val*")),App(Seq(CallNoArgs(SVar("relation-try-term-to-uri")),CallT(SVar("relation-lookup-internal"),[],[Var("rel")])),Var("term"))))))),RDefT("relation-lookup-internal",[],[DefaultVarDec("rel")],Rule(Var("term"),NoAnnoList(List([Var(ListVar("stat-val*")),Var(ListVar("val*")),Var(ListVar("trans-val*"))])),Seq(Assign(Var(ListVar("stat-val*")),App(CallT(SVar("get-static-relations"),[],[Var("rel")]),Var("term"))),Seq(Assign(Var(ListVar("val*")),App(CallT(SVar("get-index-relations"),[],[Var("rel")]),Var("term"))),Assign(Var(ListVar("trans-val*")),App(LChoice(Seq(CallNoArgs(SVar("relation-is-transitive")),BA(CallT(SVar("get-index-relations-transitive"),[],[Var("rel")]),Var("term"))),Build(NoAnnoList(List([])))),Var("rel")))))))]),Rules([RDefT("relation-match",[],[DefaultVarDec("rel"),DefaultVarDec("expected")],Rule(Var("actual"),Var("expected"),BA(LChoice(Call(SVar("zip"),[CallT(SVar("relation-match-internal"),[],[Var("rel")])]),CallT(SVar("relation-match-internal"),[],[Var("rel")])),NoAnnoList(Tuple([Var("actual"),Var("expected")]))))),RDefT("relation-match-internal",[],[DefaultVarDec("rel")],Rule(NoAnnoList(Tuple([Var("actual"),Var("expected")])),Var("expected"),LChoice(BA(CallT(SVar("relation-match-internal-match"),[],[Var("rel")]),NoAnnoList(Tuple([Var("actual"),Var("expected")]))),LChoice(BA(Seq(Where(BA(CallNoArgs(SVar("relation-is-symmetric")),Var("rel"))),CallT(SVar("relation-match-internal-match"),[],[Var("rel")])),NoAnnoList(Tuple([Var("expected"),Var("actual")]))),Seq(Assign(Var("actual'"),App(CallNoArgs(SVar("relation-try-term-to-uri")),Var("actual"))),Seq(Assign(Var("expected'"),App(CallNoArgs(SVar("relation-try-term-to-uri")),Var("expected"))),LChoice(BA(CallT(SVar("relation-match-internal-match"),[],[Var("rel")]),NoAnnoList(Tuple([Var("actual'"),Var("expected'")]))),BA(Seq(Where(BA(CallNoArgs(SVar("relation-is-symmetric")),Var("rel"))),CallT(SVar("relation-match-internal-match"),[],[Var("rel")])),NoAnnoList(Tuple([Var("expected'"),Var("actual'")])))))))))),RDefT("relation-match-internal-match",[],[DefaultVarDec("rel")],RuleNoCond(NoAnnoList(Tuple([Var("actual"),Var("expected")])),App(CallNoArgs(SVar("relation-match-tuple")),NoAnnoList(Tuple([Var("rel"),Var("actual"),Var("expected")]))))),RDefT("relation-match-internal-match",[],[DefaultVarDec("rel")],Rule(NoAnnoList(Tuple([Var("actual"),Var("expected")])),RootApp(Id),LChoice(BA(Seq(CallT(SVar("get-index-relations"),[],[Var("rel")]),Call(SVar("fetch"),[Seq(CallNoArgs(SVar("relation-try-term-to-uri")),Match(Var("expected")))])),Var("actual")),BA(Seq(Where(BA(CallNoArgs(SVar("relation-is-transitive")),Var("rel"))),Seq(CallT(SVar("get-index-relations-transitive"),[],[Var("rel")]),Call(SVar("fetch"),[Seq(CallNoArgs(SVar("relation-try-term-to-uri")),Match(Var("expected")))]))),Var("actual")))))]),Rules([RDefT("get-index-relations",[],[DefaultVarDec("rel")],RuleNoCond(Var("term"),App(Seq(CallNoArgs(SVar("index-get-all-values")),CallNoArgs(SVar("relation-get-all-values"))),NoAnnoList(Op("RelTuple",[Var("term"),Var("rel")]))))),RDefT("get-index-relations-transitive",[],[DefaultVarDec("rel")],RuleNoCond(Var("term"),App(Seq(CallNoArgs(SVar("index-get-all-values")),CallNoArgs(SVar("relation-get-all-values"))),NoAnnoList(Op("RelTuple",[Var("term"),NoAnnoList(Op("Transitive",[Var("rel")]))]))))),SDefNoArgs("relation-get-all-values",Call(SVar("mapconcat"),[Seq(CallNoArgs(SVar("insert-results-or-delay")),LChoice(CallNoArgs(SVar("is-list")),CallNoArgs(SVar("MkSingleton"))))]))]),Rules([RDefT("get-static-relations",[],[DefaultVarDec("rel")],Rule(Var("t"),Var(ListVar("val*")),[WithClause(Seq(Assign(Var("stat-set"),RootApp(CallNoArgs(SVar("new-iset")))),Seq(BA(Call(SVar("try"),[Call(SVar("relation-store-value"),[CallT(SVar("store-tuple"),[],[Var("stat-set")])])]),NoAnnoList(Tuple([Var("rel"),Var("t")]))),Assign(Var(ListVar("val*")),App(CallNoArgs(SVar("iset-elements")),Var("stat-set"))))))])),RDefT("store-tuple",[],[DefaultVarDec("set")],Rule(Var("elem"),RootApp(Fail),[WithClause(BA(CallT(SVar("iset-add"),[],[Var("elem")]),Var("set")))]))])])